{% extends 'base_generic.html' %}

{% block title %}{{ user.get_full_name }} - Profil{% endblock %}

{% block content %}
<style>
    /* Common variables for all themes */
    :root {
        --badge-width: 300px;
        --content-max-width: 1200px;
        --glass-opacity: 0.15;
        --glass-border-opacity: 0.2;
        --text-primary: rgba(255, 255, 255, 0.95);
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
        --focus-overlay: rgba(0, 0, 0, 0.3);
        --tooltip-bg: rgba(0, 0, 0, 0.8);
        --share-button-bg: rgba(255, 255, 255, 0.1);
        --warning-text: #8E8E93;
    }
    
    /* Using theme variables from base_generic.html */
    /* Pink theme text color override */
    :root[data-theme="pink"] {
        --text-primary: rgba(255, 255, 255, 0.95);
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
    }
    
    /* Black theme styles */
    :root[data-theme="black"] {
        --text-primary: rgba(255, 255, 255, 0.95);
        --text-secondary: rgba(255, 255, 255, 0.7);
        --text-tertiary: rgba(255, 255, 255, 0.5);
    }
    
    :root[data-theme="black"] .card-paper {
        background: var(--card-paper-bg);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    :root[data-theme="black"] .card-glass {
        background: var(--card-glass-bg);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    :root[data-theme="black"] .profile-header {
        background: var(--glass-bg);
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    :root[data-theme="black"] .profile-badge {
        background: var(--card-glass-bg);
        border-color: rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    :root[data-theme="black"] .profile-content {
        background: var(--card-paper-bg);
    }
    
    :root[data-theme="black"] body {
        background: var(--background-color);
    }
    
    /* Pink accent for buttons in black theme */
    :root[data-theme="black"] .btn {
        border: 1px solid transparent;
        transition: all 0.3s ease;
    }
    
    :root[data-theme="black"] .btn:hover {
        border-color: var(--pink-accent);
        box-shadow: var(--pink-accent-shadow);
    }
    
    /* Pink accent for interactive elements in black theme */
    :root[data-theme="black"] .interactive-element:hover,
    :root[data-theme="black"] .nav-link:hover,
    :root[data-theme="black"] .profile-photo-container:hover .edit-photo-btn {
        box-shadow: var(--pink-accent-shadow);
    }
    
    :root[data-theme="black"] .form-control:focus {
        border-color: var(--text-secondary);
        box-shadow: 0 0 0 3px var(--inset-highlight);
    }

    /* Alert styles */
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .alert-success {
        background-color: #4CAF50;
    }

    .alert-error {
        background-color: #f44336;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    html, body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
        margin: 0;
        padding: 0;
        background: var(--background-color, #f69a9a);
        color: var(--text-primary);
        overflow-y: auto;
    }

    .profile-container {
        max-width: 100%;
        width: 100vw;
        margin: 40px auto 0; 
        padding: var(--spacing);
        display: grid;
        grid-template-columns: var(--badge-width) 1fr;
        gap: var(--spacing);
        min-height: calc(100vh - var(--nav-height) - 2 * var(--spacing) - 40px); /* Adjusted height for the new margin */
        box-sizing: border-box;
        overflow-x: hidden;
    }

    .profile-badge {
        position: sticky;
        top: 20px;
        height: fit-content;
        background: rgba(255, 255, 255, var(--glass-opacity));
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
        padding: var(--spacing);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transform-style: preserve-3d;
        transition: transform 0.3s ease;
    }

    .profile-badge:hover {
        transform: translateY(-5px) rotateX(5deg);
    }

    /* Responsive Design - g√ºncellenmi≈ü */
    @media (max-width: 1024px) {
        .profile-container {
            grid-template-columns: 1fr;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        
        .profile-badge {
            top: calc(var(--nav-height) + 20px); /* Original sticky position on mobile/tablet */
        }

        .profile-badge {
            position: relative;
            top: 0;
            margin-bottom: var(--spacing);
            max-width: 100%;
            box-sizing: border-box;
        }
    }

    @media (max-width: 768px) {
        html, body {
            overflow-x: hidden;
        }
        
        .profile-container {
            padding: 10px;
            gap: 15px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin-top: calc(var(--nav-height) + 10px); /* Add space for fixed navbar */
            padding-bottom: 20px; /* Add some bottom padding */
        }

        .profile-badge, .profile-content {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 0;
            padding: 20px 15px;
            position: relative;
            top: 0;
        }
        
        .profile-badge {
            margin-top: 10px; /* Add some space between navbar and profile */
        }

        .profile-photo-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }

        .profile-name {
            font-size: 1.3rem;
            word-break: break-word;
            hyphens: auto;
        }

        .profile-meta {
            font-size: 0.9rem;
            word-break: break-word;
        }

        /* Form elemanlarƒ± i√ßin mobil optimizasyonu */
        .form-control {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 16px; /* iOS zoom'u √∂nlemek i√ßin */
        }

        .input-container {
            width: 100%;
            box-sizing: border-box;
        }

        /* Butonlar i√ßin mobil optimizasyonu */
        .edit-name-btn, .save-btn {
            position: static;
            margin-top: 8px;
            margin-left: auto;
            display: block;
        }

        .name-actions {
            position: static;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .name-group.editing input {
            padding-right: 15px;
        }

        /* Share button mobil pozisyonu */
        .share-button {
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
        }

        /* Modal mobil optimizasyonu */
        .modal-content {
            width: 95%;
            max-width: 95%;
            margin: 10px;
            box-sizing: border-box;
        }

        .photo-preview-area {
            height: 200px;
        }

        /* Badge stats mobil g√∂r√ºn√ºm√º */
        .badge-stats {
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-value {
            font-size: 1.2rem;
        }

        .stat-label {
            font-size: 0.8rem;
        }

        /* Section header mobil */
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .personal-info-header {
            width: 100%;
            justify-content: space-between;
            margin-right: 0;
        }

        /* Alert mobil pozisyonu */
        .alert {
            top: 10px;
            right: 10px;
            left: 10px;
            width: auto;
            box-sizing: border-box;
        }
    }


    @media (max-width: 480px) {
        .profile-container {
            padding: 8px;
            gap: 12px;
        }

        .profile-badge, .profile-content {
            padding: 12px;
        }

        .profile-photo-container {
            width: 100px;
            height: 100px;
        }

        .profile-name {
            font-size: 1.2rem;
        }


        .section-title {
            font-size: 1.2rem;
        }


        .form-control {
            padding: 10px 12px;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
        }

        .modal-content {
            padding: 15px;
        }

        .photo-preview-area {
            height: 150px;
        }
    }

    /* T√ºm √∂ƒüeler i√ßin box-sizing */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    .profile-photo-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 24px;
    }

    .profile-photo {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 3px solid var(--white);
        background: var(--glass-color);
        position: relative;
        overflow: hidden;
    }

    .profile-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none; /* Initially hidden */
    }

    .profile-photo .initials {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        font-weight: 600;
        color: var(--white);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .photo-upload-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: var(--primary-color);
        width: 40px;
        height: 40px;
        border: 2px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 2;
    }

    .photo-upload-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .photo-upload-button i {
        font-size: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 2;
    }

    .photo-upload-overlay i {
        color: var(--white);
        font-size: 1.3rem;
    }

    .photo-error-message {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: var(--white);
        font-size: 0.8rem;
        padding: 4px 8px;
        text-align: center;
        display: none;
    }

    .badge-info {
        text-align: center;
        color: var(--text-primary);
    }

    .profile-name {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
    }

    .profile-meta {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .badge-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 20px 0;
    }

    .badge-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 20px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Content Section */
    .profile-content {
        position: relative;
        background: rgba(255, 255, 255, var(--glass-opacity));
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
        padding: var(--spacing);
        color: var(--text-primary);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .edit-button {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 8px 12px;
        border-radius: 8px;
    }

    .edit-button:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .warning-text {
        font-size: 0.75rem;
        color: var(--warning-text);
        font-style: italic;
        margin: -15px 0 20px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--white);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .form-control:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Focus Mode */
    .focus-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--focus-overlay);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .focus-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    /* Photo Upload Modal */
    .photo-upload-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: rgba(255, 255, 255, var(--glass-opacity));
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, var(--glass-border-opacity));
        padding: var(--spacing);
        width: 90%;
        max-width: 500px;
        color: var(--text-primary);
        transform: translateY(20px);
        opacity: 0;
        transition: all 0.3s ease;
    }

    .modal-content.active {
        transform: translateY(0);
        opacity: 1;
    }

    .photo-preview-area {
        width: 100%;
        height: 300px;
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .photo-preview-area:hover {
        border-color: var(--white);
        background: rgba(255, 255, 255, 0.05);
    }

    .photo-preview-area.dragging {
        border-color: var(--primary-color);
        background: rgba(255, 255, 255, 0.1);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: var(--primary-color);
        color: var(--white);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--white);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .profile-container {
            grid-template-columns: 1fr;
        }

        .profile-badge {
            position: relative;
            top: 0;
            margin-bottom: var(--spacing);
        }
    }

    @media (max-width: 768px) {
        .profile-container {
            padding: calc(var(--spacing) / 2);
        }

        .profile-photo-container {
            width: 150px;
            height: 150px;
        }

        .profile-name {
            font-size: 1.5rem;
        }

        .profile-meta {
            font-size: 1rem;
        }
    }

    /* Share Button */
    .share-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--share-button-bg);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--text-primary);
        z-index: 10;
    }

    .share-button:active {
        transform: scale(0.95);
    }

    .share-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .share-button i {
        font-size: 1.2rem;
    }

    /* Education Section */
    .education-header {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-icon {
        color: var(--text-tertiary);
        cursor: help;
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        font-size: 0.9rem;
        font-style: normal;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--tooltip-bg);
        color: var(--white);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .info-icon:hover .tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-8px);
    }

    /* Graduation Year Styling */
    .graduation-year {
        display: inline-flex;
        align-items: baseline;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .graduation-year .year {
        font-size: 1.1em;
        font-weight: 500;
    }

    .graduation-year .apostrophe {
        font-size: 1.2em;
        font-weight: 300;
        font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
        margin-left: -2px;
        vertical-align: super;
        line-height: 0;
    }

    .personal-info-header {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: flex-start;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .department-group {
        margin-bottom: 30px;
    }
    
    .department-input-container {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .save-btn {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .save-btn:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.1);
    }
    
    .save-btn i {
        font-size: 1rem;
    }

    .input-container {
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .edit-name-btn {
        position: absolute;
        left: 200px;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: space-around;
        transition: all 0.2s ease;
    }

    .save-btn {
        position: absolute;
        right: 10px;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .edit-name-btn:hover, .save-btn:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.1);
    }
    
    .edit-name-btn i, .save-btn i {
        font-size: 1rem;
    }

    .edit-warning {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-top: 4px;
        font-style: italic;
    }

    .name-group {
        position: relative;
    }

    .name-actions {
        display: none;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        gap: 8px;
    }

    .name-group.editing .name-actions {
        display: flex;
    }

    .name-group.editing input {
        padding-right: 90px;
    }
</style>

<div class="profile-container">
    <!-- Badge Section -->
    <div class="profile-badge">
        <div class="profile-photo-container">
            <div class="profile-photo" id="profilePhoto">
                {% if has_photo and photo_url %}
                    <img src="{{ photo_url }}" 
                         alt="{{ user.get_full_name }}"
                         onerror="handlePhotoError(this)"
                         onload="handlePhotoLoad(this)">
                {% endif %}
                <div class="initials">{{ user.get_initials }}</div>
                <div class="photo-error-message">Fotoƒüraf y√ºklenemedi</div>
            </div>
            <button class="photo-upload-button" onclick="openPhotoUpload()" aria-label="Fotoƒürafƒ± deƒüi≈ütir">
                <i class="fas fa-camera"></i>
            </button>
        </div>
        <div class="badge-info">
            <h1 class="profile-name">{{ user.get_full_name }}</h1>
            <div class="profile-meta">
                {% if user.school %}
                    {{ user.school.name }}<br>
                    {{ user.graduation_year.year }}
                    {% if user.department %}
                        <br><span class="department-text">{{ user.department }} B√∂l√ºm√º</span>
                    {% endif %}
                {% else %}
                    <a href="{% url 'school_login' %}" class="btn btn-primary">
                        <i class="fas fa-university"></i>
      Okula Giri≈ü Yap
    </a>
  {% endif %}
            </div>
            <div class="badge-divider"></div>
            <div class="badge-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ sent_messages_count }}</div>
                    <div class="stat-label">Yazƒ±lan</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ received_messages_count }}</div>
                    <div class="stat-label">Alƒ±nan</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="profile-content">
        <!-- Share Button -->
        <button class="share-button" onclick="shareProfile()">
            <i class="fas fa-share-alt"></i>
        </button>

        <div class="section-header">
            <div class="personal-info-header">
                <h2 class="section-title">Ki≈üisel Bilgiler</h2>
                {% if not user.has_edited_name %}
                <button type="button" class="edit-name-btn" onclick="toggleNameEdit()" title="ƒ∞sim ve soyisim sadece bir kez d√ºzenlenebilir">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <form id="personalForm">
            {% csrf_token %}
            <div class="form-group name-group">
                <label for="firstName">Ad</label>
                <div class="input-container">
                    <input type="text" id="firstName" class="form-control" value="{{ user.first_name }}" disabled>
                </div>
            </div>
            <div class="form-group name-group">
                <label for="lastName">Soyad</label>
                <div class="input-container">
                    <input type="text" id="lastName" class="form-control" value="{{ user.last_name }}" disabled>
                </div>
                {% if not user.has_edited_name %}
                <div class="edit-warning">ƒ∞sim ve soyisim bilgilerinizi sadece bir kez d√ºzenleyebilirsiniz</div>
                {% endif %}
            </div>
            <div class="form-group department-group">
                <label for="department">B√∂l√ºm</label>
                <div class="input-container">
                    <input type="text" id="department" name="department" value="{{ user.department }}" class="form-control">
                    <button type="button" class="save-btn" onclick="saveDepartment()" title="B√∂l√ºm bilgisini kaydet">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </form>

        <div class="section-header" style="margin-top: 40px;">
            <div class="education-header">
                <h2 class="section-title">Okul Bilgileri</h2>
                <span class="info-icon">
                    ‚ìò
                    <span class="tooltip">Okul ve mezuniyet yƒ±lƒ± doƒürulama sonrasƒ± d√ºzenlenemez</span>
                </span>
            </div>
        </div>
        <div class="form-group">
            <label>√úniversite</label>
            <input type="text" class="form-control" value="{{ user.school.name }}" disabled>
        </div>
        <div class="form-group">
            <label>Mezuniyet Yƒ±lƒ±</label>
            <input type="text" class="form-control" value="{{ user.graduation_year.year }}" disabled>
        </div>
    </div>
</div>

<!-- Focus Overlay -->
<div class="focus-overlay" id="focusOverlay"></div>

<!-- Photo Upload Modal -->
<div class="photo-upload-modal" id="photoUploadModal">
    <div class="modal-content">
        <div class="section-header">
            <h2 class="section-title">Profil Fotoƒürafƒ± Y√ºkle</h2>
            <button class="edit-button" onclick="closePhotoUpload()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="photo-preview-area" id="photoDropArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Fotoƒüraf y√ºklemek i√ßin tƒ±klayƒ±n veya s√ºr√ºkleyin</p>
            <input type="file" id="photoInput" accept="image/*" style="display: none" onchange="handlePhotoSelect(event)">
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePhotoUpload()">
                <i class="fas fa-times"></i>
                ƒ∞ptal
            </button>
            <button class="btn btn-primary" onclick="savePhoto()" id="savePhotoBtn" disabled>
                <i class="fas fa-save"></i>
                Kaydet
            </button>
        </div>
    </div>
</div>

<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    let isEditing = false;
    let selectedPhoto = null;
    let hasEditedName = {% if user.has_edited_name %}true{% else %}false{% endif %};

    // Initialize tilt effect on badge
    const badge = document.querySelector('.profile-badge');
    if (badge) {
        badge.addEventListener('mousemove', (e) => {
            const rect = badge.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateX = (y - centerY) / 20;
            const rotateY = (centerX - x) / 20;
            
            badge.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });
        
        badge.addEventListener('mouseleave', () => {
            badge.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
        });
    }

    function toggleEdit(section) {
        const form = document.getElementById(section + 'Form');
        const inputs = form.querySelectorAll('input');
        const editBtn = document.getElementById('edit' + section.charAt(0).toUpperCase() + section.slice(1) + 'Btn');
        const focusOverlay = document.getElementById('focusOverlay');

        isEditing = !isEditing;

        if (isEditing) {
            if (!hasEditedName) {
                const confirm = window.confirm('ƒ∞sim ve soyisim bilgilerinizi sadece bir kez d√ºzenleyebilirsiniz. Devam etmek istiyor musunuz?');
                if (!confirm) {
                    isEditing = false;
                    return;
                }
            }
            inputs.forEach(input => input.disabled = false);
            editBtn.innerHTML = '<i class="fas fa-save"></i>';
            focusOverlay.classList.add('active');
        } else {
            saveChanges(section, form);
            inputs.forEach(input => input.disabled = true);
            editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            focusOverlay.classList.remove('active');
        }
    }

    async function saveChanges(section, form) {
        try {
            let data;
            let headers = {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            };
            
            if (section === 'personal') {
                // For personal info, use JSON format
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const department = document.getElementById('department').value;
                
                data = {
                    firstName: firstName,
                    lastName: lastName,
                    department: department
                };
                
                headers['Content-Type'] = 'application/json';
                
                const response = await fetch(`/profile/update/${section}/`, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: headers
                });
                
                const responseData = await response.json();
                if (responseData.success) {
                    showMessage('Deƒüi≈üiklikler kaydedildi', 'success');
                    hasEditedName = true;
                    // Update department display if it was changed
                    if (department) {
                        const departmentDisplay = document.querySelector('.profile-meta');
                        const existingDepartment = departmentDisplay.querySelector('.department-text');
                        if (existingDepartment) {
                            existingDepartment.textContent = `${department} B√∂l√ºm√º`;
                        } else {
                            const departmentText = document.createElement('div');
                            departmentText.className = 'department-text';
                            departmentText.textContent = `${department} B√∂l√ºm√º`;
                            departmentDisplay.appendChild(departmentText);
                        }
                    }
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showMessage(responseData.error, 'error');
                }
            } else {
                // For other sections, use FormData
                const formData = new FormData(form);
                const response = await fetch(`/profile/update/${section}/`, {
                    method: 'POST',
                    body: formData,
                    headers: headers
                });
                
                const responseData = await response.json();
                if (responseData.success) {
                    showMessage('Deƒüi≈üiklikler kaydedildi', 'success');
                } else {
                    showMessage(responseData.error, 'error');
                }
            }
        } catch (error) {
            showMessage('Bir hata olu≈ütu', 'error');
            console.error('Error:', error);
        }
    }

    function openPhotoUpload() {
        const modal = document.getElementById('photoUploadModal');
        const modalContent = modal.querySelector('.modal-content');
        modal.style.display = 'flex';
        setTimeout(() => modalContent.classList.add('active'), 10);
        document.getElementById('photoInput').value = '';
    }

    function closePhotoUpload() {
        const modal = document.getElementById('photoUploadModal');
        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);

        selectedPhoto = null;
        document.getElementById('savePhotoBtn').disabled = true;

        const previewArea = document.getElementById('photoDropArea');

        // Clear inner HTML and remove all child nodes
        previewArea.innerHTML = '';

        // Add icons/text again
        const icon = document.createElement('i');
        icon.className = 'fas fa-cloud-upload-alt';

        const text = document.createElement('p');
        text.textContent = 'Fotoƒüraf y√ºklemek i√ßin tƒ±klayƒ±n veya s√ºr√ºkleyin';

        // Create new input
        const newInput = document.createElement('input');
        newInput.type = 'file';
        newInput.accept = 'image/*';
        newInput.style.display = 'none';
        newInput.id = 'photoInput';

        // Bind the new onchange event
        newInput.addEventListener('change', handlePhotoSelect);

        // Append to preview area
        previewArea.appendChild(icon);
        previewArea.appendChild(text);
        previewArea.appendChild(newInput);

        // Rebind click to open input
        previewArea.onclick = () => {
            newInput.click();
        };
    }

    function handleDragOver(e) {
        e.preventDefault();
        document.getElementById('photoDropArea').classList.add('dragging');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        document.getElementById('photoDropArea').classList.remove('dragging');
    }

    function handleDrop(e) {
        e.preventDefault();
        document.getElementById('photoDropArea').classList.remove('dragging');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handlePhoto(files[0]);
        }
    }

    function handlePhotoSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handlePhoto(files[0]);
        }
    }

    function handlePhoto(file) {
        if (!file.type.startsWith('image/')) {
            showMessage('L√ºtfen ge√ßerli bir resim dosyasƒ± se√ßin', 'error');
            return;
        }

        selectedPhoto = file;
        document.getElementById('savePhotoBtn').disabled = false;

        const reader = new FileReader();
        reader.onload = function(e) {
            const previewArea = document.getElementById('photoDropArea');
            previewArea.innerHTML = `
                <img src="${e.target.result}" 
                     style="max-width: 100%; max-height: 280px; border-radius: 8px;"
                     onerror="handleImageError(this)">
            `;
        };
        reader.onerror = function(error) {
            console.error('Error reading file:', error);
            showMessage('Dosya okunurken bir hata olu≈ütu', 'error');
        };
        reader.readAsDataURL(file);
    }

    function handleImageError(img) {
        console.error('Image failed to load:', img.src);
        const previewArea = document.getElementById('photoDropArea');
        previewArea.innerHTML = `
            <i class="fas fa-image"></i>
            <p>Fotoƒüraf y√ºklenemedi</p>
        `;
    }

    async function savePhoto() {
        if (!selectedPhoto) return;

        const formData = new FormData();
        formData.append('photo', selectedPhoto);

        try {
            const response = await fetch('/profile/update-photo/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();
            if (data.success) {
                showMessage('Profil fotoƒürafƒ± g√ºncellendi', 'success');
                location.reload();
            } else {
                showMessage(data.error, 'error');
            }
        } catch (error) {
            showMessage('Bir hata olu≈ütu', 'error');
        }

        closePhotoUpload();
    }

    function showMessage(message, type) {
        // Implementation of message display
        console.log(`${type}: ${message}`);
    }

    // Function to show alerts
    function showAlert(type, message) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type}`;
        alertContainer.textContent = message;
        
        document.body.appendChild(alertContainer);
        
        // Remove the alert after 3 seconds
        setTimeout(() => {
            alertContainer.remove();
        }, 3000);
    }

    // Initialize photo upload area click handler
    document.getElementById('photoDropArea').addEventListener('click', () => {
        document.getElementById('photoInput').click();
    });
    
    // Share Profile Functionality - Temizlenmi≈ü Versiyon
    async function shareProfile() {
        try {
            // Kullanƒ±cƒ± bilgilerini al
            const userSchool = '{{ user.school.name }}';
            const userGraduationYear = '{{ user.graduation_year.year }}';
            const userName = '{{ user.get_full_name }}';
            
            // Sadece login sayfasƒ± URL'i
            const loginUrl = 'https://yillik.site/login/';
            
            // Payla≈üƒ±m metni - login URL'i ile birlikte tam metin
            const shareText = `üëã ${userName}'in √ºni yƒ±llƒ±k profilini ke≈üfet!

    üè´ ${userSchool}
    üéì ${userGraduationYear} mezunu

    üí¨ Benimle ileti≈üime ge√ßmek i√ßin bu d√∂neme kaydolabilirsin!

    üîó ${loginUrl}`;
            
            if (navigator.share) {
                try {
                    // Sadece metin payla≈ü (URL parametresi yok)
                    await navigator.share({
                        title: `${userName} - √úni Yƒ±llƒ±k Profili`,
                        text: shareText
                    });
                } catch (error) {
                    // Fallback'e ge√ß
                    throw error;
                }
            } else {
                // Fallback - t√ºm bilgileri kopyala
                fallbackShare(shareText);
            }
        } catch (error) {
            // Hata durumunda fallback
            fallbackShare();
        }
    }

    // Fallback payla≈üƒ±m fonksiyonu
    function fallbackShare(customText = null) {
        try {
            let shareContent;
            
            if (customText) {
                shareContent = customText;
            } else {
                const userSchool = '{{ user.school.name }}';
                const userGraduationYear = '{{ user.graduation_year.year }}';
                const userName = '{{ user.get_full_name }}';
                
                const loginUrl = 'https://yillik.site/login/';
                
                shareContent = `üëã ${userName}'in √ºni yƒ±llƒ±k profilini ke≈üfet!

    üè´ ${userSchool}
    üéì ${userGraduationYear} mezunu

    üí¨ Benimle ileti≈üime ge√ßmek i√ßin bu d√∂neme kaydolabilirsin!

    üîó ${loginUrl}`;
            }
            
            // Clipboard API dene
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareContent).then(() => {
                    showMessage('Profil bilgileri kopyalandƒ±!', 'success');
                }).catch(() => {
                    // Eski y√∂ntem
                    copyToClipboardOldWay(shareContent);
                });
            } else {
                copyToClipboardOldWay(shareContent);
            }
        } catch (error) {
            showMessage('Payla≈üƒ±m ba≈üarƒ±sƒ±z', 'error');
        }
    }

    // Eski y√∂ntem ile kopyala
    function copyToClipboardOldWay(text) {
        const dummy = document.createElement('textarea');
        document.body.appendChild(dummy);
        dummy.value = text;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        showMessage('Profil bilgileri kopyalandƒ±!', 'success');
    }

    // Test fonksiyonu - Sadece metin payla≈üƒ±mƒ±
    function testShareTextOnly() {
        const userName = 'Eray Ko√ß';
        const userSchool = '.Test √úniversitesi';
        const userGraduationYear = '2026';
        const loginUrl = 'https://yillik.site/login/';
        
        const shareText = `üëã ${userName}'in √ºni yƒ±llƒ±k profilini ke≈üfet!

    üè´ ${userSchool}
    üéì ${userGraduationYear} mezunu

    üí¨ Benimle ileti≈üime ge√ßmek i√ßin bu d√∂neme kaydolabilirsin!

    üîó ${loginUrl}`;
        
        if (navigator.share) {
            navigator.share({
                title: `${userName} - √úni Yƒ±llƒ±k Profili`,
                text: shareText
            }).then(() => {
                // Test ba≈üarƒ±lƒ±
            }).catch(error => {
                // Test hatasƒ±
            });
        } else {
            copyToClipboardOldWay(shareText);
        }
    }

    // Enhanced tooltip positioning
    document.querySelectorAll('.info-icon').forEach(icon => {
        const tooltip = icon.querySelector('.tooltip');
        const updateTooltipPosition = () => {
            const rect = icon.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (rect.left - tooltipRect.width / 2 < 0) {
                tooltip.style.left = '0';
                tooltip.style.transform = 'translateX(0)';
            } else if (rect.right + tooltipRect.width / 2 > window.innerWidth) {
                tooltip.style.left = 'auto';
                tooltip.style.right = '0';
                tooltip.style.transform = 'translateX(0)';
            } else {
                tooltip.style.left = '50%';
                tooltip.style.right = 'auto';
                tooltip.style.transform = 'translateX(-50%)';
            }
        };

        icon.addEventListener('mouseenter', updateTooltipPosition);
        window.addEventListener('resize', updateTooltipPosition);
    });

    // Initialize photo handling
    document.addEventListener('DOMContentLoaded', function() {
        const photoImg = document.querySelector('.profile-photo img');
        if (photoImg) {
            photoImg.onerror = function() {
                handlePhotoError(this);
            };
            photoImg.onload = function() {
                handlePhotoLoad(this);
            };
        }
    });

    function handlePhotoLoad(img) {
        const container = img.parentElement;
        const initials = container.querySelector('.initials');
        const errorMessage = container.querySelector('.photo-error-message');
        
        img.style.display = 'block';
        initials.style.display = 'none';
        errorMessage.style.display = 'none';
    }

    function handlePhotoError(img) {
        const container = img.parentElement;
        const initials = container.querySelector('.initials');
        const errorMessage = container.querySelector('.photo-error-message');
        
        img.style.display = 'none';
        initials.style.display = 'block';
        errorMessage.style.display = 'block';
    }

    function toggleNameEdit() {
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const editBtn = document.querySelector('.edit-name-btn');
        
        if (firstNameInput.disabled) {
            // Enable editing
            firstNameInput.disabled = false;
            lastNameInput.disabled = false;
            editBtn.innerHTML = '<i class="fas fa-check"></i>';
            editBtn.title = 'Deƒüi≈üiklikleri kaydet';
        } else {
            // Save changes
            savePersonalInfo();
            firstNameInput.disabled = true;
            lastNameInput.disabled = true;
            editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            editBtn.title = 'ƒ∞sim ve soyisim sadece bir kez d√ºzenlenebilir';
        }
    }

    function saveDepartment() {
        const department = document.getElementById('department').value.trim();
        if (!department) {
            showAlert('error', 'L√ºtfen b√∂l√ºm bilgisini giriniz.');
            return;
        }

        fetch('/profile/update/personal/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                department: department
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'B√∂l√ºm bilgisi ba≈üarƒ±yla g√ºncellendi');
            } else {
                showAlert('error', data.error || 'B√∂l√ºm bilgisi g√ºncellenirken bir hata olu≈ütu.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'B√∂l√ºm bilgisi g√ºncellenirken bir hata olu≈ütu.');
        });
    }

    // Update savePersonalInfo to handle name changes
    function savePersonalInfo() {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const department = document.getElementById('department').value;
        
        if (!firstName || !lastName) {
            showAlert('error', 'Ad ve soyad alanlarƒ± bo≈ü bƒ±rakƒ±lamaz');
            return;
        }

        fetch('/profile/update/personal/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                firstName: firstName,
                lastName: lastName,
                department: department
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'ƒ∞sim ve soyisim bilgileriniz g√ºncellendi');
                // Update the name display
                document.querySelector('.profile-name').textContent = `${firstName} ${lastName}`;
                // Disable inputs and update UI
                document.getElementById('firstName').disabled = true;
                document.getElementById('lastName').disabled = true;
                // Remove edit button as it can only be used once
                document.querySelector('.edit-name-btn').remove();
                document.querySelector('.edit-warning').remove();
            } else {
                showAlert('error', data.error || 'Bir hata olu≈ütu');
            }
        })
        .catch(error => {
            showAlert('error', 'Bir hata olu≈ütu');
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}